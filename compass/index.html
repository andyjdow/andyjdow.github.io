<head>
  <title>Compass</title>

  <!-- Handle scaling on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Positioning:
        o "absolute" position set an elements position within the next parent element with "relative" position. 
        o "relative" position mean it can be position relative to itself as placed in document order 
       Sizing (& positioning) and div arrangement copied from lamplightdev/compass which seems to rotate with no issues
        o Don't really understand how it works as the svg container divs are kind of set to zero size! 
        o Note we also rotate the container div rather than the svg
        o The key entry seemed to be adding overflow=hidden to the compass container div, without it I got the same
          behavior as with my initial attempt using vh & vw to successfully auto scale the SVGs 
          o I guess this deals with the rotation of the surrounding box which causes a change in the overall width and height
  -->
  <style type="text/css">
    #compass {
      position: relative;
      height: 70%;
      width: 100%;
      overflow: hidden;
      box-sizing: border-box;
    }
    #rose_container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 0;
    }
    #rose {
      height: 100%;
      width: 100%;
    }
    #needle_container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }
    #needle {
      height: 100%;
      width: 100%;
    }
    #track_container {
      position: relative;
      height: 80%;
      width: 100%;
      /* Is below necessary ? */
      overflow: hidden;
      box-sizing: border-box;
      /*visibility: hidden;*/
      display: none;
    }
    #track {
      height: 100%;
      width: 100%;
    }
    #heading_container {
      position: relative;
      height: 10%;
      width: 100%;
      /* border-box ensures 100% includes any rogue padding and it doesn't overrun the page */
      box-sizing: border-box;
      /*font-size: large;*/
    }
    #slider {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
    }
    #heading {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      text-align: center;
    }
    #startstop_container {
      position: relative;
      height: 10%;
      width: 100%;
      box-sizing: border-box;
      /*display: flex;*/
    }
    #statstop {
      position: absolute;
      top: 0;
      left: 0;
    }
    #message {
      /*font-size: large;*/
      position: absolute;
      top: 0;
      right: 0;
    }
  </style>
  <!-- Positioning:
        o "absolute" position set an elements position within the next parent element with "relative" position. 
        o "relative" position mean it can be position relative to itself as placed in document order
       The "vh" (viewpoert height) & "vw" (viewport width) were the only things I could get to work to correctly scale the image
        o  https://stackoverflow.com/questions/27612931/styling-html-and-body-selector-to-height-100-vs-using-100vh -->
  <!-- <style type="text/css">
    #compass {
      position: relative;
    }
    #rose {
      /*  */
      position: absolute;
      top: 0;
      left: 0;
      height: 90vh;
      width: 100vw;
      z-index: 0;
    }
    #needle {
      position: absolute;
      top: 0;
      left: 0;
      height: 90vh;
      width: 100vw;
      z-index: 1;
    }
  </style> -->
</head>
<body>
  <div id="compass">
    <div id="rose_container">
      <svg id="rose" version="1.1" viewBox="0 0 80.465 80.465"xmlns="http://www.w3.org/2000/svg"xmlns:cc="http://creativecommons.org/ns#"xmlns:dc="http://purl.org/dc/elements/1.1/"xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
        <metadata>
          <rdf:RDF>
            <cc:Work rdf:about="">
              <dc:format>image/svg+xml</dc:format>
              <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/>
              <dc:title/>
            </cc:Work>
          </rdf:RDF>
        </metadata>
        <g transform="translate(.2325 .2325)">
          <g fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <circle cx="40" cy="40" r="40" fill="none" stroke="#000" stroke-width=".465"/>
          <g transform="rotate(80 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(10 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(20 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(70 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(30 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(60 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(40 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(50 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <ellipse cx="40.062" cy="40.123" rx="33.805" ry="33.743" fill="none" stroke="#000" stroke-width=".323"/>
          <g fill="#000000" font-family="sans-serif">
            <text transform="scale(.98363 1.0166)" x="38.318161" y="5.6435556" font-size="5.0813px" stroke-width=".12703" style="line-height:1.25" xml:space="preserve"><tspan x="38.318161" y="5.6435556" font-weight="bold" stroke-width=".12703">N</tspan></text>
            <g font-size="5.0813px" stroke-width=".12703">
              <text transform="matrix(0 .98363 -1.0166 0 0 0)" x="38.889778" y="-73.207962" style="line-height:1.25" xml:space="preserve"><tspan x="38.889778" y="-73.207962" font-weight="bold" stroke-width=".12703">E</tspan></text>
              <text transform="scale(-.98363 -1.0166)" x="-42.412056" y="-73.273277" style="line-height:1.25" xml:space="preserve"><tspan x="-42.412056" y="-73.273277" font-weight="bold" stroke-width=".12703">S</tspan></text>
              <text transform="matrix(0 -.98363 1.0166 0 0 0)" x="-43.625999" y="5.5284638" style="line-height:1.25" xml:space="preserve"><tspan x="-43.625999" y="5.5284638" font-weight="bold" stroke-width=".12703">W</tspan></text>
            </g>
            <text transform="matrix(.95131 .34625 -.33784 .92821 0 0)" x="48.03627" y="-10.358718" font-size="4.2015px" stroke-width=".10504" style="line-height:1.25" xml:space="preserve"><tspan x="48.03627" y="-10.358718" stroke-width=".10504">20</tspan></text>
            <g font-size="4.2015px" stroke-width=".10504">
              <text transform="matrix(.77552 .65074 -.63494 .75669 0 0)" x="53.085007" y="-29.664335" style="line-height:1.25" xml:space="preserve"><tspan x="53.085007" y="-29.664335" stroke-width=".10504">40</tspan></text>
              <text transform="matrix(.50618 .87673 -.85545 .49389 0 0)" x="51.518383" y="-49.638081" style="line-height:1.25" xml:space="preserve"><tspan x="51.518383" y="-49.638081" stroke-width=".10504">60</tspan></text>
              <text transform="matrix(.1758 .99699 -.97278 .17153 0 0)" x="43.260281" y="-67.808342" style="line-height:1.25" xml:space="preserve"><tspan x="43.260281" y="-67.808342" stroke-width=".10504">80</tspan></text>
              <text transform="matrix(-.1758 .99699 -.97278 -.17153 0 0)" x="28.069746" y="-81.832481" style="line-height:1.25" xml:space="preserve"><tspan x="28.069746" y="-81.832481" stroke-width=".10504">100</tspan></text>
              <text transform="matrix(-.50618 .87673 -.85545 -.49389 0 0)" x="10.368654" y="-90.363251" style="line-height:1.25" xml:space="preserve"><tspan x="10.368654" y="-90.363251" stroke-width=".10504">120</tspan></text>
              <text transform="matrix(-.77552 .65074 -.63494 -.75669 0 0)" x="-9.3716278" y="-92.047745" style="line-height:1.25" xml:space="preserve"><tspan x="-9.3716278" y="-92.047745" stroke-width=".10504">140</tspan></text>
              <text transform="matrix(-.95131 .34625 -.33784 -.92821 0 0)" x="-27.592531" y="-86.820335" style="line-height:1.25" xml:space="preserve"><tspan x="-27.592531" y="-86.820335" stroke-width=".10504">160</tspan></text>
              <text transform="matrix(-.95131 -.34625 .33784 -.92821 0 0)" x="-54.736382" y="-59.185238" style="line-height:1.25" xml:space="preserve"><tspan x="-54.736382" y="-59.185238" stroke-width=".10504">200</tspan></text>
              <text transform="matrix(-.77552 -.65074 .63494 -.75669 0 0)" x="-59.544521" y="-39.940136" style="line-height:1.25" xml:space="preserve"><tspan x="-59.544521" y="-39.940136" stroke-width=".10504">220</tspan></text>
              <text transform="matrix(-.50618 -.87673 .85545 -.49389 0 0)" x="-58.454197" y="-20.134676" style="line-height:1.25" xml:space="preserve"><tspan x="-58.454197" y="-20.134676" stroke-width=".10504">240</tspan></text>
              <text transform="matrix(-.1758 -.99699 .97278 -.17153 0 0)" x="-49.920563" y="-2.068289" style="line-height:1.25" xml:space="preserve"><tspan x="-49.920563" y="-2.068289" stroke-width=".10504">260</tspan></text>
              <text transform="matrix(.1758 -.99699 .97278 .17153 0 0)" x="-36.010082" y="11.998429" style="line-height:1.25" xml:space="preserve"><tspan x="-36.010082" y="11.998429" stroke-width=".10504">280</tspan></text>
              <text transform="matrix(.50618 -.87673 .85545 .49389 0 0)" x="-18.508804" y="20.492743" style="line-height:1.25" xml:space="preserve"><tspan x="-18.508804" y="20.492743" stroke-width=".10504">300</tspan></text>
              <text transform="matrix(.77552 -.65074 .63494 .75669 0 0)" x="0.91190743" y="22.373159" style="line-height:1.25" xml:space="preserve"><tspan x="0.91190743" y="22.373159" stroke-width=".10504">320</tspan></text>
              <text transform="matrix(.95131 -.34625 .33784 .92821 0 0)" x="19.448372" y="17.080835" style="line-height:1.25" xml:space="preserve"><tspan x="19.448372" y="17.080835" stroke-width=".10504">340</tspan></text>
            </g>
          </g>
          <g transform="matrix(1 0 0 1.2105 0 -1.3684)" fill="none" stroke="#f00">
            <path d="m40 6.5 9 9.5" stroke-width=".565"/>
            <path d="m40 6.5-9 9.5" stroke-width=".565"/>
          </g>
          <g fill="none">
            <g stroke-width=".565">
              <path d="m36 12v28" stroke="#f00"/>
              <path d="m44 12v28" stroke="#f00"/>
              <path d="m36 40v33.5" stroke="#000"/>
              <path d="m44 40v33.5" stroke="#000"/>
            </g>
            <g stroke="#f00">
              <path d="m36 17 4-5 4 5" stroke-width=".565"/>
              <path d="m36 20.5 4-5 4 5" stroke-width=".565"/>
              <path d="m36 24 4-5 4 5" stroke-width=".565"/>
            </g>
          </g>
        </g>
      </svg>
    </div>
    <!-- NOTE: Manually correct viewBox to match above -->
    <div id="needle_container">
      <svg id="needle" version="1.1" viewBox="0 0 80.465 80.465" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
        <metadata>
          <rdf:RDF>
            <cc:Work rdf:about="">
              <dc:format>image/svg+xml</dc:format>
              <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/>
              <dc:title/>
            </cc:Work>
          </rdf:RDF>
        </metadata>
        <g>
          <g stroke="#000">
            <ellipse cx="40.132" cy="40.115" rx="5.867" ry="5.8375" fill="#f00" stroke-width=".26997"/>
            <path d="m42.132 34.632v-23.5l-2-4.5-2 4.5v23.5" fill="#f00" stroke-width=".26458px"/>
            <path d="m42.132 45.632v23.5l-2 4.5-2-4.5v-23.5" fill="#fff" stroke-width=".26458px"/>
            <ellipse cx="40.122" cy="40.144" rx="3.9086" ry="3.8869" stroke-width=".20658"/>
          </g>
          <rect x="38.632" y="17.132" width="3" height="7" fill="#fff"/>
          <text transform="scale(.91698 1.0905)" x="41.707207" y="14.292045" fill="#ffffff" font-family="sans-serif" font-size="4.8923px" stroke-width=".12231" style="line-height:1.25" xml:space="preserve"><tspan x="41.707207" y="14.292045" fill="#ffffff" font-weight="bold" stroke-width=".12231">N</tspan></text>
        </g>
      </svg>
    </div>
  </div>
  <div id="track_container">
    <canvas id="track"></canvas>
  </div>
  <dir id="heading_container">
    <input id="slider"  type="range"  min="0" max="359" value="0">
    <input id="heading" type="number" min="0" max="359" value="0">
  </dir>
  <div id="startstop_container">
    <button id="startstop" type="button">Start Track</button>
    <input id="samplers" type="number" value="3">
    <div id="message">Heading will display here</div>
  </div>
  <div id="debug">
  </div>
  <script type="text/javascript">
    // Globals
    var ver = 2;

    // Get element objects
    var message           = document.getElementById('message');
    var rose              = document.getElementById('rose_container');
    var needle            = document.getElementById('needle_container');
    var slider            = document.getElementById('slider');
    var heading_container = document.getElementById('heading_container');
    var heading           = document.getElementById('heading');
    var startstop         = document.getElementById('startstop');
    var track_container   = document.getElementById('track_container');
    var track_canvas      = document.getElementById('track');
    var track_draw        = track_canvas.getContext("2d");
    var samplers          = document.getElementById('samplers');
    var debug             = document.getElementById('debug');
    
    var track     = [];
    var samp_hist = [];

    var sampler = [];
    // var sampler1          = -1;
    // var sampler2          = -1;
    // var sampler3          = -1;

    // var sample_cnt        = [-1, -1, -1];
    // var sample            = [0 , 0 ,  0];
    function sample_location(inst) {
      // console.log("Sampler "+inst);
      let options = {
        enableHighAccuracy: true,
        timeout: Infinity,
        maximumAge: 0
      };
      navigator.geolocation.getCurrentPosition(function(position) {
        // sample_cnt[inst]++;
        // sample[inst] = position.coords; 
        // let log_sample = true;
        // let cnt_test   = sample_cnt[inst]; 
        // for (var i = 0; i < sample_cnt.length; i++) {
        //   if (sample_cnt[i] != cnt_test) {
        //     log_sample = false;
        //   }
        // }
        // if (log_sample) {
        //   // Average samples then log
        //   let lat = 0;
        //   let lng = 0;
        //   for (var i = 0; i < sample_cnt.length; i++) {
        //     lat += sample[inst].latitude;
        //     lng += sample[inst].longitude;
        //   }
        //   lat = lat / sample_cnt.length;
        //   lng = lng / sample_cnt.length;
        //   // Have we moved enough?
        //   let dist = -1;
        //   if (track.length > 0) {
        //     let prev_latlng = track[track.length-1];
        //     dist            = Math.sqrt(Math.pow(lat-prev_latlng[0],2)+Math.pow(lng-prev_latlng[1],2));
        //   }
        //   // 0.00001 approx to 1 metre
        //   if (dist > 0.00001 || dist == -1) {
        //     // Log
        //     console.log("Inst "+inst+": "+lat+","+lng);
        //     track.push([lat,lng]);
        //   }
        // }
        debug.innerHTML = debug.innerHTML + "sampler: "+inst+": "+position.coords.latitude+","+position.coords.longitude+"</br>";
        track[inst].push([position.coords.latitude,position.coords.longitude]);
      },
      function(error) {
        alert(error.code+": "+error.message);
      },
      options);
    }; // end sample_location

    if (window.DeviceMotionEvent) {
      window.addEventListener('deviceorientation', function(event) {
        var rotation = 0;
        if (event.webkitCompassHeading) {
          // message.innerHTML = "CompassHeading("+ver+"): " + event.webkitCompassHeading;
          message.innerHTML = "Heading: " + event.webkitCompassHeading.toFixed(0);
          rotation = event.webkitCompassHeading;
        } else if (event.alpha) {
          // message.innerHTML = "Alpha("+ver+"): " + event.alpha;
          message.innerHTML = "Heading: " + event.alpha.toFixed(0);
          rotation = event.alpha;
        } else {
          // message.innerHTML = "Alpha("+ver+") is undefined ";
          message.innerHTML = "Alpha or webkitCompassHeading is undefined. ";
        }
        // Requires too high a precision to see motion and display well
        // if (track.length > 0) {
        //   let latlng = track[track.length-1];
        //   message.innerHTML = message.innerHTML + " latlng: "+latlng[0].toFixed(4)+", "+latlng[1].toFixed(4);
        // }
        // Rotate needle
        needle.style.transform = "rotate("+rotation+"deg)";
      });
    } else {
      window.alert("Device orientation not supported. :-(");
    }

    slider.addEventListener('input', function() {
      heading.value = slider.value;
      rose.style.transform = "rotate(-"+slider.value+"deg)";
    })

    heading.addEventListener('input', function() {
      rose.style.transform = "rotate(-"+heading.value+"deg)";
      slider.value = heading.value;
    })

    startstop.addEventListener('click', function() {
      if (startstop.innerHTML == "Start Track") {
        startstop.innerHTML = "Stop Track"
        debug.innerHTML = "";
        let options = {
          enableHighAccuracy: true,
          timeout: Infinity,
          maximumAge: 0
        };
        if (navigator.geolocation) {
          track = [];
          console.log("Starting geolocation...")
          // // Start location
          // navigator.geolocation.getCurrentPosition(function(position) {
          //     console.log(position.coords.latitude+","+position.coords.longitude)
          //     track.push([position.coords.latitude,position.coords.longitude]);
          //   },
          //   function(error) {
          //     alert(error.code+": "+error.message);
          //   },
          //   options);
          // // Now enable tracking as we move 
          sampler = navigator.geolocation.watchPosition(function(position) {
              // console.log(position.coords.latitude+","+position.coords.longitude)
              // let lastlatlng = track[track.length-1];
              // if (lastlatlng[0] != position.coords.latitude && lastlatlng[1] != position.coords.longitude && track.length > 0) {
              //   track.push([position.coords.latitude,position.coords.longitude]);
              // }
              
              debug.innerHTML = debug.innerHTML + "sampled: "+position.coords.latitude+","+position.coords.longitude+"</br>";

              samp_hist.push(position.coords);
              if (samp_hist.length >= samplers.value) {
                let lat = 0;
                let lng = 0;
                for (var i = 0; i < samp_hist.length; i++) {
                  lat += samp_hist[i].latitude;
                  lng += samp_hist[i].longitude;
                }
                lat = lat / samplers.value;
                lng = lng / samplers.value;
                track.push([lat,lng]);
                samp_hist.shift();
              }
            },
            function(error) {
              alert(error.code+": "+error.message);
            },
            options);
          // Used time based sampling
          // o Using 3 "samplers" to try to generate a more accurate location
          // sampler1 = setInterval(sample_location,500,0);
          // sampler2 = setInterval(sample_location,500,1);
          // sampler3 = setInterval(sample_location,500,2);
          // sampler = [];
          // for (var i = 0; i < samplers.value; i++) {
          //   track.push([]);
          //   let s = setInterval(sample_location,500,i);
          //   sampler.push(s);
          // }
        } else {
          window.alert("Geolocation is not supported. :-(")
        }
      } else if (startstop.innerHTML == "Done") {
        startstop.innerHTML = "Start Track"
        compass.style.display = "block";
        heading_container.style = "block";
        track_container.style.display= "none";
      } else {
        startstop.innerHTML = "Start Track"
        // navigator.geolocation.clearWatch(sample_location);
        navigator.geolocation.clearWatch(sampler);
        // clearInterval(sampler1);
        // clearInterval(sampler2);
        // clearInterval(sampler3);
        // let min_track = track[0].length;
        // for (var i = 0; i < samplers.value; i++) {
        //   clearInterval(sampler[i]);
        //   if (track[i].length < min_track) {
        //     min_track = track[i].length;
        //   }
        // }
        var str = "";
        // let av_track = [];
        // // Calculate "average" track
        // for (var i = 0; i < min_track; i++) {
        //   let lat = 0;
        //   let lng = 0;
        //   for (var j = 0; j < samplers.value; j++) {
        //     let latlng = track[j][i];
        //     lat += latlng[0];
        //     lng += latlng[1];
        //     str = str + i + ": " + j + ": " + latlng[0]+", "+latlng[1]+", "+lat + ", "+lng+"</br>";
        //   }
        //   lat = lat / samplers.value;
        //   lng = lng / samplers.value;
        //   av_track.push([lat,lng]);
        // }
        let av_track = track;
        str = str + "Samples: "+av_track.length+"</br>";
        for (var i = 0; i < av_track.length; i++) {
          let latlng = av_track[i];
          str = str+ latlng[0]+", "+latlng[1]+"</br>";
        }
        // alert(str);
        debug.innerHTML = str;
        if (av_track.length > 0) {
          if (confirm("View track?")) {
            // Using display to hide but apparently it means we can't use transitions, may want to revisit
            compass.style.display = "none";
            heading_container.style.display = "none";
            track_container.style.display= "block";
            startstop.innerHTML = "Done";
            // Clear any existing track
            if (confirm("Clear?")) {
              track_draw.clearRect(0,0,track_canvas.width,track_canvas.height);
            }
            //
            track_draw.imageSmoothingEnabled = false;
            // Draw track
            let maxLat  = av_track[0][0];
            let minLat  = av_track[0][0];
            let maxLng  = av_track[0][1];
            let minLng  = av_track[0][1];
            for (var i = 1; i < av_track.length; i++) {
              let latlng = av_track[i];
              if (latlng[0] > maxLat) {
                maxLat = latlng[0];
              }
              if (latlng[0] < minLat) {
                minLat = latlng[0];
              }
              if (latlng[1] > maxLng ) {
                maxLng  = latlng[1];
              }
              if (latlng[1] < minLng ) {
                minLng  = latlng[1];
              }
            }
            let latRange  = maxLat  - minLat;
            let lngRange  = maxLng  - minLng;
            let scaleLat  = track_canvas.height / latRange;
            let scaleLng  = track_canvas.width / lngRange;
            let scale = scaleLng;
            if (scaleLat < scaleLng) {
              scale = scaleLat;
            }
            // str = latRange + ", " + longRange + ", " + track_canvas.width + ", " + track_canvas.height + ", " + scale;
            // alert(str);
            for (var i = 0; i < av_track.length; i++) {
              let latlng = av_track[i];
              let x = (latlng[1]-minLng)*scale;
              let y = track_canvas.height - (latlng[0]-minLat)*scale;
              str = str+ latlng[1] + ", " + minLng  + ", " + latlng[0] + ", " + minLat + ", " + x + ", " + y + "</br>";
              // alert(str);
              if (i==0) {
                track_draw.moveTo(x,y);
                // track_draw.fillText(""+i,x,y);
              } else {
                track_draw.lineTo(x,y);
                track_draw.stroke();
              }
              // if (i == av_track.length-1) {
              //   track_draw.fillText(""+i,x,y);
              // }
            }
            // alert(str);
            debug.innerHTML = str;
          }
        }
      }
    })

  </script>

</body>
