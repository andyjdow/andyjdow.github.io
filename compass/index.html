<head>
  <title>Compass</title>

  <!-- Handle scaling on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Positioning:
        o "absolute" position set an elements position within the next parent element with "relative" position. 
        o "relative" position mean it can be position relative to itself as placed in document order 
       Sizing (& positioning) and div arrangement copied from lamplightdev/compass which seems to rotate with no issues
        o Don't really understand how it works as the svg container divs are kind of set to zero size! 
        o Note we also rotate the container div rather than the svg
        o The key entry seemed to be adding overflow=hidden to the compass container div, without it I got the same
          behavior as with my initial attempt using vh & vw to successfully auto scale the SVGs 
          o I guess this deals with the rotation of the surrounding box which causes a change in the overall width and height
  -->
  <style type="text/css">
    #compass {
      position: relative;
      height: 70%;
      width: 100%;
      overflow: hidden;
      box-sizing: border-box;
    }
    #rose_container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 0;
    }
    #rose {
      height: 100%;
      width: 100%;
    }
    #needle_container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }
    #needle {
      height: 100%;
      width: 100%;
    }
    #track_container {
      position: relative;
      height: 80%;
      /*height: 90%;*/
      width: 100%;
      /* Is below necessary ? */
      /*overflow: hidden;*/
      box-sizing: border-box;
      display: none;
    }
    #track {
      position: absolute;
      top: 0;
      left: 0;
      /*height: 100%;*/
      height: 90%;
      width: 100%;
    }
    /*#distance {
      position: absolute;
      bottom: 7%;
      left: 0;
      width: 100%;
    }*/
    #average {
      position: absolute;
      bottom: 2%;
      left: 0;
      width: 100%;
    }
    #heading_container {
      position: relative;
      height: 10%;
      width: 100%;
      /* border-box ensures 100% includes any rogue padding and it doesn't overrun the page */
      box-sizing: border-box;
      /*font-size: large;*/
    }
    #slider {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
    }
    #heading {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      text-align: center;
    }
    #startstop_container {
      position: relative;
      height: 10%;
      width: 100%;
      box-sizing: border-box;
      /*display: flex;*/
    }
    #statstop {
      position: absolute;
      top: 0;
      left: 0;
    }
    #message {
      /*font-size: large;*/
      position: absolute;
      top: 0;
      right: 0;
    }
  </style>
  <!-- Positioning:
        o "absolute" position set an elements position within the next parent element with "relative" position. 
        o "relative" position mean it can be position relative to itself as placed in document order
       The "vh" (viewpoert height) & "vw" (viewport width) were the only things I could get to work to correctly scale the image
        o  https://stackoverflow.com/questions/27612931/styling-html-and-body-selector-to-height-100-vs-using-100vh -->
  <!-- <style type="text/css">
    #compass {
      position: relative;
    }
    #rose {
      /*  */
      position: absolute;
      top: 0;
      left: 0;
      height: 90vh;
      width: 100vw;
      z-index: 0;
    }
    #needle {
      position: absolute;
      top: 0;
      left: 0;
      height: 90vh;
      width: 100vw;
      z-index: 1;
    }
  </style> -->
</head>
<body>
  <div id="compass">
    <div id="rose_container">
      <svg id="rose" version="1.1" viewBox="0 0 80.465 80.465"xmlns="http://www.w3.org/2000/svg"xmlns:cc="http://creativecommons.org/ns#"xmlns:dc="http://purl.org/dc/elements/1.1/"xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
        <metadata>
          <rdf:RDF>
            <cc:Work rdf:about="">
              <dc:format>image/svg+xml</dc:format>
              <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/>
              <dc:title/>
            </cc:Work>
          </rdf:RDF>
        </metadata>
        <g transform="translate(.2325 .2325)">
          <g fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <circle cx="40" cy="40" r="40" fill="none" stroke="#000" stroke-width=".465"/>
          <g transform="rotate(80 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(10 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(20 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(70 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(30 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(60 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(40 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(50 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <ellipse cx="40.062" cy="40.123" rx="33.805" ry="33.743" fill="none" stroke="#000" stroke-width=".323"/>
          <g fill="#000000" font-family="sans-serif">
            <text transform="scale(.98363 1.0166)" x="38.318161" y="5.6435556" font-size="5.0813px" stroke-width=".12703" style="line-height:1.25" xml:space="preserve"><tspan x="38.318161" y="5.6435556" font-weight="bold" stroke-width=".12703">N</tspan></text>
            <g font-size="5.0813px" stroke-width=".12703">
              <text transform="matrix(0 .98363 -1.0166 0 0 0)" x="38.889778" y="-73.207962" style="line-height:1.25" xml:space="preserve"><tspan x="38.889778" y="-73.207962" font-weight="bold" stroke-width=".12703">E</tspan></text>
              <text transform="scale(-.98363 -1.0166)" x="-42.412056" y="-73.273277" style="line-height:1.25" xml:space="preserve"><tspan x="-42.412056" y="-73.273277" font-weight="bold" stroke-width=".12703">S</tspan></text>
              <text transform="matrix(0 -.98363 1.0166 0 0 0)" x="-43.625999" y="5.5284638" style="line-height:1.25" xml:space="preserve"><tspan x="-43.625999" y="5.5284638" font-weight="bold" stroke-width=".12703">W</tspan></text>
            </g>
            <text transform="matrix(.95131 .34625 -.33784 .92821 0 0)" x="48.03627" y="-10.358718" font-size="4.2015px" stroke-width=".10504" style="line-height:1.25" xml:space="preserve"><tspan x="48.03627" y="-10.358718" stroke-width=".10504">20</tspan></text>
            <g font-size="4.2015px" stroke-width=".10504">
              <text transform="matrix(.77552 .65074 -.63494 .75669 0 0)" x="53.085007" y="-29.664335" style="line-height:1.25" xml:space="preserve"><tspan x="53.085007" y="-29.664335" stroke-width=".10504">40</tspan></text>
              <text transform="matrix(.50618 .87673 -.85545 .49389 0 0)" x="51.518383" y="-49.638081" style="line-height:1.25" xml:space="preserve"><tspan x="51.518383" y="-49.638081" stroke-width=".10504">60</tspan></text>
              <text transform="matrix(.1758 .99699 -.97278 .17153 0 0)" x="43.260281" y="-67.808342" style="line-height:1.25" xml:space="preserve"><tspan x="43.260281" y="-67.808342" stroke-width=".10504">80</tspan></text>
              <text transform="matrix(-.1758 .99699 -.97278 -.17153 0 0)" x="28.069746" y="-81.832481" style="line-height:1.25" xml:space="preserve"><tspan x="28.069746" y="-81.832481" stroke-width=".10504">100</tspan></text>
              <text transform="matrix(-.50618 .87673 -.85545 -.49389 0 0)" x="10.368654" y="-90.363251" style="line-height:1.25" xml:space="preserve"><tspan x="10.368654" y="-90.363251" stroke-width=".10504">120</tspan></text>
              <text transform="matrix(-.77552 .65074 -.63494 -.75669 0 0)" x="-9.3716278" y="-92.047745" style="line-height:1.25" xml:space="preserve"><tspan x="-9.3716278" y="-92.047745" stroke-width=".10504">140</tspan></text>
              <text transform="matrix(-.95131 .34625 -.33784 -.92821 0 0)" x="-27.592531" y="-86.820335" style="line-height:1.25" xml:space="preserve"><tspan x="-27.592531" y="-86.820335" stroke-width=".10504">160</tspan></text>
              <text transform="matrix(-.95131 -.34625 .33784 -.92821 0 0)" x="-54.736382" y="-59.185238" style="line-height:1.25" xml:space="preserve"><tspan x="-54.736382" y="-59.185238" stroke-width=".10504">200</tspan></text>
              <text transform="matrix(-.77552 -.65074 .63494 -.75669 0 0)" x="-59.544521" y="-39.940136" style="line-height:1.25" xml:space="preserve"><tspan x="-59.544521" y="-39.940136" stroke-width=".10504">220</tspan></text>
              <text transform="matrix(-.50618 -.87673 .85545 -.49389 0 0)" x="-58.454197" y="-20.134676" style="line-height:1.25" xml:space="preserve"><tspan x="-58.454197" y="-20.134676" stroke-width=".10504">240</tspan></text>
              <text transform="matrix(-.1758 -.99699 .97278 -.17153 0 0)" x="-49.920563" y="-2.068289" style="line-height:1.25" xml:space="preserve"><tspan x="-49.920563" y="-2.068289" stroke-width=".10504">260</tspan></text>
              <text transform="matrix(.1758 -.99699 .97278 .17153 0 0)" x="-36.010082" y="11.998429" style="line-height:1.25" xml:space="preserve"><tspan x="-36.010082" y="11.998429" stroke-width=".10504">280</tspan></text>
              <text transform="matrix(.50618 -.87673 .85545 .49389 0 0)" x="-18.508804" y="20.492743" style="line-height:1.25" xml:space="preserve"><tspan x="-18.508804" y="20.492743" stroke-width=".10504">300</tspan></text>
              <text transform="matrix(.77552 -.65074 .63494 .75669 0 0)" x="0.91190743" y="22.373159" style="line-height:1.25" xml:space="preserve"><tspan x="0.91190743" y="22.373159" stroke-width=".10504">320</tspan></text>
              <text transform="matrix(.95131 -.34625 .33784 .92821 0 0)" x="19.448372" y="17.080835" style="line-height:1.25" xml:space="preserve"><tspan x="19.448372" y="17.080835" stroke-width=".10504">340</tspan></text>
            </g>
          </g>
          <g transform="matrix(1 0 0 1.2105 0 -1.3684)" fill="none" stroke="#f00">
            <path d="m40 6.5 9 9.5" stroke-width=".565"/>
            <path d="m40 6.5-9 9.5" stroke-width=".565"/>
          </g>
          <g fill="none">
            <g stroke-width=".565">
              <path d="m36 12v28" stroke="#f00"/>
              <path d="m44 12v28" stroke="#f00"/>
              <path d="m36 40v33.5" stroke="#000"/>
              <path d="m44 40v33.5" stroke="#000"/>
            </g>
            <g stroke="#f00">
              <path d="m36 17 4-5 4 5" stroke-width=".565"/>
              <path d="m36 20.5 4-5 4 5" stroke-width=".565"/>
              <path d="m36 24 4-5 4 5" stroke-width=".565"/>
            </g>
          </g>
        </g>
      </svg>
    </div>
    <!-- NOTE: Manually correct viewBox to match above -->
    <div id="needle_container">
      <svg id="needle" version="1.1" viewBox="0 0 80.465 80.465" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
        <metadata>
          <rdf:RDF>
            <cc:Work rdf:about="">
              <dc:format>image/svg+xml</dc:format>
              <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/>
              <dc:title/>
            </cc:Work>
          </rdf:RDF>
        </metadata>
        <g>
          <g stroke="#000">
            <ellipse cx="40.132" cy="40.115" rx="5.867" ry="5.8375" fill="#f00" stroke-width=".26997"/>
            <path d="m42.132 34.632v-23.5l-2-4.5-2 4.5v23.5" fill="#f00" stroke-width=".26458px"/>
            <path d="m42.132 45.632v23.5l-2 4.5-2-4.5v-23.5" fill="#fff" stroke-width=".26458px"/>
            <ellipse cx="40.122" cy="40.144" rx="3.9086" ry="3.8869" stroke-width=".20658"/>
          </g>
          <rect x="38.632" y="17.132" width="3" height="7" fill="#fff"/>
          <text transform="scale(.91698 1.0905)" x="41.707207" y="14.292045" fill="#ffffff" font-family="sans-serif" font-size="4.8923px" stroke-width=".12231" style="line-height:1.25" xml:space="preserve"><tspan x="41.707207" y="14.292045" fill="#ffffff" font-weight="bold" stroke-width=".12231">N</tspan></text>
        </g>
      </svg>
    </div>
  </div>
  <div id="track_container">
    <canvas id="track"></canvas>
    <!-- <input id="distance"  type="range"  min="0" max="5"  value="0" step="0.1"> -->
    <input id="average"   type="range"  min="1" max="10" value="1">
  </div>
  <dir id="heading_container">
    <input id="slider"  type="range"  min="0" max="359" value="0">
    <input id="heading" type="number" min="0" max="359" value="0">
  </dir>
  <div id="startstop_container">
    <button id="startstop" type="button">Start Track</button>
    <div id="message">Heading will display here</div>
  </div>
  <div id="debug">
  </div>
  <script type="text/javascript">

    var test_track = [
      [55.8901513,-3.343884],
      [55.8901491,-3.3439146],
      [55.8901894,-3.3439773],
      [55.8901898,-3.3439778],
      [55.8902151,-3.3439445],
      [55.8902381,-3.3439076],
      [55.8902743,-3.3438412],
      [55.8902891,-3.3437808],
      [55.8902976,-3.3437119],
      [55.8902841,-3.3437981],
      [55.890294, -3.3437918],
      [55.890304, -3.3437847],
      [55.8903158,-3.3437486],
      [55.8903201,-3.343728],
      [55.8903247,-3.3436935],
      [55.8903264,-3.3436625],
      [55.8903267,-3.3436442],
      [55.8903266,-3.3436197],
      [55.8903265,-3.3436031],
      [55.890326, -3.3435832],
      [55.8903295,-3.343558],
      [55.8903346,-3.3435333],
      [55.8903366,-3.3435202],
      [55.8903388,-3.3434995],
      [55.8903396,-3.3434896],
      [55.8903414,-3.3434679],
      [55.8903418,-3.3434615],
      [55.8903431,-3.3434401],
      [55.8903429,-3.3434265],
      [55.8903392,-3.3434161],
      [55.8903336,-3.3434092],
      [55.8903273,-3.3434086],
      [55.8903196,-3.3434095],
      [55.8903113,-3.343412],
      [55.8903042,-3.3434143],
      [55.8902887,-3.3434247],
      [55.8902728,-3.3434438],
      [55.8902634,-3.343457],
      [55.890254, -3.3434673],
      [55.8902463,-3.3434737],
      [55.8902375,-3.3434804],
      [55.890229, -3.3434864],
      [55.8902208,-3.343496],
      [55.890214, -3.3435012],
      [55.8902067,-3.3435038],
      [55.8902002,-3.3435054],
      [55.8901913,-3.3435074],
      [55.8901836,-3.3435091],
      [55.8901773,-3.3435106],
      [55.8901695,-3.3435139],
      [55.8901647,-3.3435171],
      [55.8901612,-3.3435207],
      [55.8901542,-3.3435277],
      [55.890145, -3.3435468],
      [55.8901422,-3.3435633],
      [55.8901415,-3.3435749],
      [55.8901405,-3.3435914],
      [55.8901403,-3.3435952],
      [55.8901414,-3.3436058],
      [55.8901451,-3.3436173],
      [55.890148, -3.3436275],
      [55.8901522,-3.3436513],
      [55.8901554,-3.3436686],
      [55.890158, -3.343682],
      [55.8901598,-3.3436992],
      [55.8901601,-3.34371],
      [55.8901614,-3.3437253],
      [55.8901631,-3.3437334],
      [55.8901671,-3.3437515],
      [55.8901707,-3.3437661],
      [55.8901737,-3.3437827],
      [55.8901769,-3.3437987],
      [55.8901791,-3.3438112],
      [55.8901818,-3.343824],
      [55.8901847,-3.3438379],
      [55.8901892,-3.3438572],
      [55.8901919,-3.3438695],
      [55.890195, -3.3438871],
      [55.8901959,-3.3438934],
      [55.8901963,-3.3438966],
      [55.8901961,-3.3438972],
      [55.8901954,-3.3438927],
      [55.8901942,-3.3438906],
      [55.8901936,-3.3438935],
      [55.8901933,-3.3438957],
      [55.8901929,-3.3438966],
      [55.8901927,-3.3438973],
      [55.8901926,-3.3438981],
      [55.8901925,-3.3438955],
      [55.8901912,-3.3438974],
      [55.8901909,-3.3438992],
      [55.8901908,-3.3439006],
      [55.8901907,-3.3439018],
      [55.8901905,-3.3439027],
      [55.8901902,-3.3439026],
      [55.8901881,-3.3439034],
      [55.8901875,-3.3439046],
      [55.8901874,-3.3439055],
      [55.8901879,-3.3438941],
      [55.8901881,-3.3438878],
      [55.8901882,-3.3438835],
      [55.8901883,-3.3438811],
      [55.8901884,-3.3438804],
      [55.8901884,-3.3438799],
      [55.8901884,-3.3438797],
      [55.8901884,-3.3438783],
      [55.8901884,-3.3438775],
      [55.8901884,-3.3438772],
      [55.8901884,-3.3438769],
      [55.8901884,-3.3438768],
      [55.8901884,-3.3438767],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766],
      [55.8901884,-3.3438766]
    ];

    // Globals
    var ver = 2;

    // Get element objects
    var message           = document.getElementById('message');
    var rose              = document.getElementById('rose_container');
    var needle            = document.getElementById('needle_container');
    var slider            = document.getElementById('slider');
    var heading_container = document.getElementById('heading_container');
    var heading           = document.getElementById('heading');
    var startstop         = document.getElementById('startstop');
    var track_container   = document.getElementById('track_container');
    var track_canvas      = document.getElementById('track');
    var track_draw        = track_canvas.getContext("2d");
    var average           = document.getElementById('average');
    // var distance          = document.getElementById('distance');
    var debug             = document.getElementById('debug');
    
    // Hide debug
    debug.style.display = "none";

    function heading_change(event) {
      var rotation = 0;
      if (event.webkitCompassHeading) {
        message.innerHTML = "Heading: " + event.webkitCompassHeading.toFixed(0);
        rotation = event.webkitCompassHeading;
      } else if (event.alpha) {
        message.innerHTML = "Heading: " + event.alpha.toFixed(0);
        rotation = event.alpha;
      } else {
        message.innerHTML = "Alpha or webkitCompassHeading is undefined. ";
      }
      // Rotate needle
      needle.style.transform = "rotate("+rotation+"deg)";
    }

    var startup = [];
    var track   = [];
    var sampler = [];

    function start_sampler() {
      let options = {
        enableHighAccuracy: true,
        timeout: Infinity,
        maximumAge: 0
      };
      sampler = navigator.geolocation.watchPosition(function(position) {
        // debug.innerHTML = debug.innerHTML + "sampled: "+position.coords.latitude+","+position.coords.longitude+"</br>";
        // track.push([position.coords.latitude,position.coords.longitude]);
        let startup_cnt = 5; // 2 or greater
        if (startup.length == 0) {
          startup.push([position.coords.latitude,position.coords.longitude]);
        } else if (startup.length < startup_cnt) {
          let too_far = false
          for (var i = 0; i < startup.length; i++) {
            let prev_latlng = startup[startup.length-1];
            let latlng      = [position.coords.latitude,position.coords.longitude];
            let dist        = Math.sqrt(Math.pow(latlng[0]-prev_latlng[0],2)+Math.pow(latlng[1]-prev_latlng[1],2));
            if (dist > 2e-5) {
              too_far = true
            }
          }
          if (too_far) {
            // remove the first element
            startup.shift()
          }
          startup.push([position.coords.latitude,position.coords.longitude]);
          if (startup.length==startup_cnt) {
            track.push([position.coords.latitude,position.coords.longitude]);
            startstop.innerHTML = "Stop Track"
          }
        } else if (startup.length >= startup_cnt) {
          // Have we moved far enough?
          let prev_latlng = track[track.length-1];
          let latlng      = [position.coords.latitude,position.coords.longitude];
          let dist        = Math.sqrt(Math.pow(latlng[0]-prev_latlng[0],2)+Math.pow(latlng[1]-prev_latlng[1],2));
          if (dist >= 2e-5) {
            debug.innerHTML = debug.innerHTML + "sampled: "+position.coords.latitude+","+position.coords.longitude+"</br>";
            track.push(latlng);
          }
        }
      },
      function(error) {
        alert(error.code+": "+error.message);
      },
      options);
    }

    function draw_track() {
      
      let samp_hist = [];
      let av_track  = [];

      track_draw.imageSmoothingEnabled = false;
      track_draw.clearRect(0,0,track_canvas.width,track_canvas.height);
      track_draw.beginPath(); // Required to get the clear to work!!!

      let skip_samples = 0;
      // Going to skip initial sample as sometimes it can be erroneous
      if (track.length > skip_samples) {
        let str = "";
        // str = "Processing track. Average: "+average.value+" Distance: "+distance.value*1e-5+"</br>"
        av_track.push(track[skip_samples])
        for (var i = 2; i < track.length; i++) {
          // let prev_latlng = av_track[av_track.length-1];
          // let latlng      = track[i];
          // dist = Math.sqrt(Math.pow(latlng[0]-prev_latlng[0],2)+Math.pow(latlng[1]-prev_latlng[1],2));
          // str = str + dist + "</br>"
          // debug.innerHTML = str
          // if (dist >= distance.value*1e-5) {
          //   samp_hist.push(track[i]);
          // }
          samp_hist.push(track[i]);

          if (samp_hist.length >= average.value) {
            let lat = 0;
            let lng = 0;
            for (var j = 0; j < samp_hist.length; j++) {
              lat += samp_hist[j][0];
              lng += samp_hist[j][1];
            }
            lat = lat / average.value;
            lng = lng / average.value;
            av_track.push([lat,lng]);
            samp_hist.shift();
          }
        }

        str = str + "Samples: "+av_track.length+"</br>";
        for (var i = 0; i < av_track.length; i++) {
          let latlng = av_track[i];
          str = str+ latlng[0]+", "+latlng[1]+"</br>";
        }
        debug.innerHTML = str;

        // Draw track
        let maxLat  = av_track[0][0];
        let minLat  = av_track[0][0];
        let maxLng  = av_track[0][1];
        let minLng  = av_track[0][1];
        for (var i = 1; i < av_track.length; i++) {
          let latlng = av_track[i];
          if (latlng[0] > maxLat) {
            maxLat = latlng[0];
          }
          if (latlng[0] < minLat) {
            minLat = latlng[0];
          }
          if (latlng[1] > maxLng ) {
            maxLng  = latlng[1];
          }
          if (latlng[1] < minLng ) {
            minLng  = latlng[1];
          }
        }
        let latRange  = (maxLat  - minLat);
        let lngRange  = (maxLng  - minLng);
        let scaleLat  = track_canvas.height / latRange;
        let scaleLng  = track_canvas.width / lngRange;
        let scale = scaleLng;
        if (scaleLat < scaleLng) {
          scale = scaleLat;
        }
        scale = scale * 0.95
        str = str+latRange + ", " + lngRange + ", " + track_canvas.width + ", " + track_canvas.height + ", " + scale+"</br>";
        for (var i = 0; i < av_track.length; i++) {
          let latlng = av_track[i];
          let x = track_canvas.width  *0.025 + (latlng[1]-minLng)*scale;
          let y = track_canvas.height *0.975 - (latlng[0]-minLat)*scale;
          str = str+ latlng[1] + ", " + minLng  + ", " + latlng[0] + ", " + minLat + ", " + x + ", " + y + "</br>";
          track_draw.strokeStyle = "#AD0AD8"; // Purple-ish
          if (i==0) {
            track_draw.moveTo(x,y);
          } else {
            track_draw.lineTo(x,y);
            track_draw.stroke();
          }
        }
        debug.innerHTML = str;
      }
    }

    // On iOS we need to ask permission to use the compass
    // o https://developer.apple.com/forums/thread/128376 
    //   & https://stackoverflow.com/questions/56514116/how-do-i-get-deviceorientationevent-and-devicemotionevent-to-work-on-safari
    if (window.DeviceOrientationEvent) {
      if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        startstop.innerHTML = "Permission"
      } else {
        window.addEventListener('deviceorientation', heading_change);
      }
    } else {
      window.alert("Device orientation not supported. :-(");
    }

    slider.addEventListener('input', function() {
      heading.value = slider.value;
      rose.style.transform = "rotate(-"+slider.value+"deg)";
    })

    heading.addEventListener('input', function() {
      rose.style.transform = "rotate(-"+heading.value+"deg)";
      slider.value = heading.value;
    })
    
    average.addEventListener('input', function() {
      if (startstop.innerHTML == "Done") {
        draw_track();
      }
    })

    // distance.addEventListener('input', function() {
    //   if (startstop.innerHTML == "Done") {
    //     draw_track();
    //   }
    // })

    // So we can save the tracks
    track_canvas.addEventListener('click', function() {
      let img_win = window.open();
      img_win.document.write("<img src=\""+track_canvas.toDataURL("image/png")+"\">")
    })

    startstop.addEventListener('click', function() {
      if (startstop.innerHTML == "Permission") {
        DeviceOrientationEvent.requestPermission().then(permissionState => {
          if (permissionState === 'granted') {
            window.addEventListener('deviceorientation', heading_change);
            startstop.innerHTML = "Start Track"
          }
        }).catch(console.error);
      } else if (startstop.innerHTML == "Start Track") {
        // startstop.innerHTML = "Stop Track"
        startstop.innerHTML = "Starting..."
        debug.innerHTML = "";
        // let options = {
        //   enableHighAccuracy: true,
        //   timeout: Infinity,
        //   maximumAge: 0
        // };
        if (navigator.geolocation) {
          track = [];
          console.log("Starting geolocation...")
          // // Start location
          // navigator.geolocation.getCurrentPosition(function(position) {
          //     console.log(position.coords.latitude+","+position.coords.longitude)
          //     track.push([position.coords.latitude,position.coords.longitude]);
          //   },
          //   function(error) {
          //     alert(error.code+": "+error.message);
          //   },
          //   options);
          // // Now enable tracking as we move 
          // sampler = navigator.geolocation.watchPosition(function(position) {
          //     debug.innerHTML = debug.innerHTML + "sampled: "+position.coords.latitude+","+position.coords.longitude+"</br>";
          //     // track.push([position.coords.latitude,position.coords.longitude]);
          //     // Have we moved far enough?
          //     let prev_latlng = track[track.length-1];
          //     let latlng      = [position.coords.latitude,position.coords.longitude];
          //     let dist        = Math.sqrt(Math.pow(latlng[0]-prev_latlng[0],2)+Math.pow(latlng[1]-prev_latlng[1],2));
          //     if (dist >= 2e-5) {
          //       track.push(latlng);
          //     }

          //   },
          //   function(error) {
          //     alert(error.code+": "+error.message);
          //   },
          //   options);
          start_sampler();
        } else {
          window.alert("Geolocation is not supported. :-(")
        }
      } else if (startstop.innerHTML == "Done") {
        startstop.innerHTML = "Start Track"
        compass.style.display = "block";
        heading_container.style = "block";
        track_container.style.display= "none";
      } else {
        startstop.innerHTML = "Start Track"
        navigator.geolocation.clearWatch(sampler);
        if (confirm("View track?")) {
          // Using display to hide but apparently it means we can't use transitions, may want to revisit
          startstop.innerHTML = "Done";
          compass.style.display = "none";
          heading_container.style.display = "none";
          track_container.style.display= "block";
          // A canvas has 2 width/height values with the drawing area not being set by the CSS attributes!
          // and it seems to need to be reset after setting display=none
          track_canvas.width    = track_canvas.clientWidth; 
          track_canvas.height   = track_canvas.clientHeight;
          
          if (debug.style.display != "none") {
            if (confirm("Use test track?")) {
              track = test_track;
            }
          }

          draw_track();
        }
      }
    })

  </script>

</body>
