<head>
  <title>Compass</title>

  <!-- Handle scaling on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Positioning:
        o "absolute" position set an elements position within the next parent element with "relative" position. 
        o "relative" position mean it can be position relative to itself as placed in document order 
       Sizing (& positioning) and div arrangement copied from lamplightdev/compass which seems to rotate with no issues
        o Don't really understand how it works as the svg container divs are kind of set to zero size! 
        o Note we also rotate the container div rather than the svg
        o The key entry seemed to be adding overflow=hidden to the compass container div, without it I got the same
          behavior as with my initial attempt using vh & vw to successfully auto scale the SVGs 
          o I guess this deals with the rotation of the surrounding box which causes a change in the overall width and height
  -->
  <style type="text/css">
    #compass {
      position: relative;
      height: 70%;
      width: 100%;
      overflow: hidden;
      box-sizing: border-box;
    }
    #rose_container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 0;
    }
    #rose {
      height: 100%;
      width: 100%;
    }
    #needle_container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }
    #needle {
      height: 100%;
      width: 100%;
    }
    #track_container {
      position: relative;
      height: 80%;
      width: 100%;
      /* Is below necessary ? */
      overflow: hidden;
      box-sizing: border-box;
      /*visibility: hidden;*/
      display: none;
    }
    #track {
      height: 100%;
      width: 100%;
    }
    #heading_container {
      position: relative;
      height: 10%;
      width: 100%;
      /* border-box ensures 100% includes any rogue padding and it doesn't overrun the page */
      box-sizing: border-box;
      /*font-size: large;*/
    }
    #slider {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
    }
    #heading {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      text-align: center;
    }
    #startstop_container {
      position: relative;
      height: 10%;
      width: 100%;
      box-sizing: border-box;
      /*display: flex;*/
    }
    #statstop {
      position: absolute;
      top: 0;
      left: 0;
    }
    #message {
      /*font-size: large;*/
      position: absolute;
      top: 0;
      right: 0;
    }
  </style>
  <!-- Positioning:
        o "absolute" position set an elements position within the next parent element with "relative" position. 
        o "relative" position mean it can be position relative to itself as placed in document order
       The "vh" (viewpoert height) & "vw" (viewport width) were the only things I could get to work to correctly scale the image
        o  https://stackoverflow.com/questions/27612931/styling-html-and-body-selector-to-height-100-vs-using-100vh -->
  <!-- <style type="text/css">
    #compass {
      position: relative;
    }
    #rose {
      /*  */
      position: absolute;
      top: 0;
      left: 0;
      height: 90vh;
      width: 100vw;
      z-index: 0;
    }
    #needle {
      position: absolute;
      top: 0;
      left: 0;
      height: 90vh;
      width: 100vw;
      z-index: 1;
    }
  </style> -->
</head>
<body>
  <div id="compass">
    <div id="rose_container">
      <svg id="rose" version="1.1" viewBox="0 0 80.465 80.465"xmlns="http://www.w3.org/2000/svg"xmlns:cc="http://creativecommons.org/ns#"xmlns:dc="http://purl.org/dc/elements/1.1/"xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
        <metadata>
          <rdf:RDF>
            <cc:Work rdf:about="">
              <dc:format>image/svg+xml</dc:format>
              <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/>
              <dc:title/>
            </cc:Work>
          </rdf:RDF>
        </metadata>
        <g transform="translate(.2325 .2325)">
          <g fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <circle cx="40" cy="40" r="40" fill="none" stroke="#000" stroke-width=".465"/>
          <g transform="rotate(80 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(10 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(20 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(70 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(30 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(60 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(40 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <g transform="rotate(50 40 40)" fill="none" stroke="#000" stroke-width=".26458px">
            <path d="m0 40h3"/>
            <path d="m80 40h-3"/>
            <path d="m40 0v3"/>
            <path d="m40 80v-3"/>
          </g>
          <ellipse cx="40.062" cy="40.123" rx="33.805" ry="33.743" fill="none" stroke="#000" stroke-width=".323"/>
          <g fill="#000000" font-family="sans-serif">
            <text transform="scale(.98363 1.0166)" x="38.318161" y="5.6435556" font-size="5.0813px" stroke-width=".12703" style="line-height:1.25" xml:space="preserve"><tspan x="38.318161" y="5.6435556" font-weight="bold" stroke-width=".12703">N</tspan></text>
            <g font-size="5.0813px" stroke-width=".12703">
              <text transform="matrix(0 .98363 -1.0166 0 0 0)" x="38.889778" y="-73.207962" style="line-height:1.25" xml:space="preserve"><tspan x="38.889778" y="-73.207962" font-weight="bold" stroke-width=".12703">E</tspan></text>
              <text transform="scale(-.98363 -1.0166)" x="-42.412056" y="-73.273277" style="line-height:1.25" xml:space="preserve"><tspan x="-42.412056" y="-73.273277" font-weight="bold" stroke-width=".12703">S</tspan></text>
              <text transform="matrix(0 -.98363 1.0166 0 0 0)" x="-43.625999" y="5.5284638" style="line-height:1.25" xml:space="preserve"><tspan x="-43.625999" y="5.5284638" font-weight="bold" stroke-width=".12703">W</tspan></text>
            </g>
            <text transform="matrix(.95131 .34625 -.33784 .92821 0 0)" x="48.03627" y="-10.358718" font-size="4.2015px" stroke-width=".10504" style="line-height:1.25" xml:space="preserve"><tspan x="48.03627" y="-10.358718" stroke-width=".10504">20</tspan></text>
            <g font-size="4.2015px" stroke-width=".10504">
              <text transform="matrix(.77552 .65074 -.63494 .75669 0 0)" x="53.085007" y="-29.664335" style="line-height:1.25" xml:space="preserve"><tspan x="53.085007" y="-29.664335" stroke-width=".10504">40</tspan></text>
              <text transform="matrix(.50618 .87673 -.85545 .49389 0 0)" x="51.518383" y="-49.638081" style="line-height:1.25" xml:space="preserve"><tspan x="51.518383" y="-49.638081" stroke-width=".10504">60</tspan></text>
              <text transform="matrix(.1758 .99699 -.97278 .17153 0 0)" x="43.260281" y="-67.808342" style="line-height:1.25" xml:space="preserve"><tspan x="43.260281" y="-67.808342" stroke-width=".10504">80</tspan></text>
              <text transform="matrix(-.1758 .99699 -.97278 -.17153 0 0)" x="28.069746" y="-81.832481" style="line-height:1.25" xml:space="preserve"><tspan x="28.069746" y="-81.832481" stroke-width=".10504">100</tspan></text>
              <text transform="matrix(-.50618 .87673 -.85545 -.49389 0 0)" x="10.368654" y="-90.363251" style="line-height:1.25" xml:space="preserve"><tspan x="10.368654" y="-90.363251" stroke-width=".10504">120</tspan></text>
              <text transform="matrix(-.77552 .65074 -.63494 -.75669 0 0)" x="-9.3716278" y="-92.047745" style="line-height:1.25" xml:space="preserve"><tspan x="-9.3716278" y="-92.047745" stroke-width=".10504">140</tspan></text>
              <text transform="matrix(-.95131 .34625 -.33784 -.92821 0 0)" x="-27.592531" y="-86.820335" style="line-height:1.25" xml:space="preserve"><tspan x="-27.592531" y="-86.820335" stroke-width=".10504">160</tspan></text>
              <text transform="matrix(-.95131 -.34625 .33784 -.92821 0 0)" x="-54.736382" y="-59.185238" style="line-height:1.25" xml:space="preserve"><tspan x="-54.736382" y="-59.185238" stroke-width=".10504">200</tspan></text>
              <text transform="matrix(-.77552 -.65074 .63494 -.75669 0 0)" x="-59.544521" y="-39.940136" style="line-height:1.25" xml:space="preserve"><tspan x="-59.544521" y="-39.940136" stroke-width=".10504">220</tspan></text>
              <text transform="matrix(-.50618 -.87673 .85545 -.49389 0 0)" x="-58.454197" y="-20.134676" style="line-height:1.25" xml:space="preserve"><tspan x="-58.454197" y="-20.134676" stroke-width=".10504">240</tspan></text>
              <text transform="matrix(-.1758 -.99699 .97278 -.17153 0 0)" x="-49.920563" y="-2.068289" style="line-height:1.25" xml:space="preserve"><tspan x="-49.920563" y="-2.068289" stroke-width=".10504">260</tspan></text>
              <text transform="matrix(.1758 -.99699 .97278 .17153 0 0)" x="-36.010082" y="11.998429" style="line-height:1.25" xml:space="preserve"><tspan x="-36.010082" y="11.998429" stroke-width=".10504">280</tspan></text>
              <text transform="matrix(.50618 -.87673 .85545 .49389 0 0)" x="-18.508804" y="20.492743" style="line-height:1.25" xml:space="preserve"><tspan x="-18.508804" y="20.492743" stroke-width=".10504">300</tspan></text>
              <text transform="matrix(.77552 -.65074 .63494 .75669 0 0)" x="0.91190743" y="22.373159" style="line-height:1.25" xml:space="preserve"><tspan x="0.91190743" y="22.373159" stroke-width=".10504">320</tspan></text>
              <text transform="matrix(.95131 -.34625 .33784 .92821 0 0)" x="19.448372" y="17.080835" style="line-height:1.25" xml:space="preserve"><tspan x="19.448372" y="17.080835" stroke-width=".10504">340</tspan></text>
            </g>
          </g>
          <g transform="matrix(1 0 0 1.2105 0 -1.3684)" fill="none" stroke="#f00">
            <path d="m40 6.5 9 9.5" stroke-width=".565"/>
            <path d="m40 6.5-9 9.5" stroke-width=".565"/>
          </g>
          <g fill="none">
            <g stroke-width=".565">
              <path d="m36 12v28" stroke="#f00"/>
              <path d="m44 12v28" stroke="#f00"/>
              <path d="m36 40v33.5" stroke="#000"/>
              <path d="m44 40v33.5" stroke="#000"/>
            </g>
            <g stroke="#f00">
              <path d="m36 17 4-5 4 5" stroke-width=".565"/>
              <path d="m36 20.5 4-5 4 5" stroke-width=".565"/>
              <path d="m36 24 4-5 4 5" stroke-width=".565"/>
            </g>
          </g>
        </g>
      </svg>
    </div>
    <!-- NOTE: Manually correct viewBox to match above -->
    <div id="needle_container">
      <svg id="needle" version="1.1" viewBox="0 0 80.465 80.465" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
        <metadata>
          <rdf:RDF>
            <cc:Work rdf:about="">
              <dc:format>image/svg+xml</dc:format>
              <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/>
              <dc:title/>
            </cc:Work>
          </rdf:RDF>
        </metadata>
        <g>
          <g stroke="#000">
            <ellipse cx="40.132" cy="40.115" rx="5.867" ry="5.8375" fill="#f00" stroke-width=".26997"/>
            <path d="m42.132 34.632v-23.5l-2-4.5-2 4.5v23.5" fill="#f00" stroke-width=".26458px"/>
            <path d="m42.132 45.632v23.5l-2 4.5-2-4.5v-23.5" fill="#fff" stroke-width=".26458px"/>
            <ellipse cx="40.122" cy="40.144" rx="3.9086" ry="3.8869" stroke-width=".20658"/>
          </g>
          <rect x="38.632" y="17.132" width="3" height="7" fill="#fff"/>
          <text transform="scale(.91698 1.0905)" x="41.707207" y="14.292045" fill="#ffffff" font-family="sans-serif" font-size="4.8923px" stroke-width=".12231" style="line-height:1.25" xml:space="preserve"><tspan x="41.707207" y="14.292045" fill="#ffffff" font-weight="bold" stroke-width=".12231">N</tspan></text>
        </g>
      </svg>
    </div>
  </div>
  <div id="track_container">
    <canvas id="track"></canvas>
  </div>
  <dir id="heading_container">
    <input id="slider"  type="range"  min="0" max="359" value="0">
    <input id="heading" type="number" min="0" max="359" value="0">
  </dir>
  <div id="startstop_container">
    <button id="startstop" type="button">Start Track</button>
    <div id="message">Heading will display here</div>
  </div>

  <script type="text/javascript">
    // Globals
    var ver = 2;
    var track = [];

    // Get element objects
    var message           = document.getElementById('message');
    var rose              = document.getElementById('rose_container');
    var needle            = document.getElementById('needle_container');
    var slider            = document.getElementById('slider');
    var heading_container = document.getElementById('heading_container');
    var heading           = document.getElementById('heading');
    var startstop         = document.getElementById('startstop');
    var track_container   = document.getElementById('track_container');
    var track_canvas      = document.getElementById('track');
    var track_draw        = track_canvas.getContext("2d");

    if (window.DeviceMotionEvent) {
      window.addEventListener('deviceorientation', function(event) {
        var rotation = 0;
        if (event.webkitCompassHeading) {
          // message.innerHTML = "CompassHeading("+ver+"): " + event.webkitCompassHeading;
          message.innerHTML = "Heading: " + event.webkitCompassHeading.toFixed(0);
          rotation = event.webkitCompassHeading;
        } else if (event.alpha) {
          // message.innerHTML = "Alpha("+ver+"): " + event.alpha;
          message.innerHTML = "Heading: " + event.alpha.toFixed(0);
          rotation = event.alpha;
        } else {
          // message.innerHTML = "Alpha("+ver+") is undefined ";
          // message.innerHTML = "Alpha is undefined";
          message.innerHTML = "Alpha or webkitCompassHeading is undefined. ";
        }
        // Requires too high a precision to see motion and display well
        // if (track.length > 0) {
        //   let latlong = track[track.length-1];
        //   message.innerHTML = message.innerHTML + " Latlong: "+latlong[0].toFixed(4)+", "+latlong[1].toFixed(4);
        // }
        // Rotate needle
        needle.style.transform = "rotate("+rotation+"deg)";
      });
    } else {
      // message.innerHTML = "Device orientation not supported. :-("
      window.alert("Device orientation not supported. :-(");
    }

    slider.addEventListener('input', function() {
      heading.value = slider.value;
      rose.style.transform = "rotate(-"+slider.value+"deg)";
    })

    heading.addEventListener('input', function() {
        rose.style.transform = "rotate(-"+heading.value+"deg)";
        slider.value = heading.value;
    })

    startstop.addEventListener('click', function() {
      if (startstop.innerHTML == "Start Track") {
        startstop.innerHTML = "Stop Track"
        let options = {
          enableHighAccuracy: true,
          timeout: Infinity,
          maximumAge: 0
        };
        if (navigator.geolocation) {
          track = [];
          console.log("Starting geolocation...")
          // Starting location
          navigator.geolocation.getCurrentPosition(function(position) {
            console.log(position.coords.latitude+","+position.coords.longitude)
            track.push([position.coords.latitude,position.coords.longitude]);
            alert("GPS locked");
            // Now enable tracking as we move 
            var sample_location = navigator.geolocation.watchPosition(function(position) {
              console.log(position.coords.latitude+","+position.coords.longitude)
              // TODO: Add check that we've moved before adding new location
              let lastLatLong = track[track.length-1];
              if (lastLatLong[0] != position.coords.latitude && lastLatLong[1] != position.coords.longitude) {
                track.push([position.coords.latitude,position.coords.longitude]);
              }
            },
            function(error) {
              alert(error.code+": "+error.message);
            },
            options);
          },
          function(error) {
            alert(error.code+": "+error.message);
          },
          options);
        } else {
          window.alert("Geolocation is not supported. :-(")
        }
      } else if (startstop.innerHTML == "Done") {
        startstop.innerHTML = "Start Track"
        compass.style.display = "block";
        heading_container.style = "block";
        track_container.style.display= "none";
      } else {
        startstop.innerHTML = "Start Track"
        navigator.geolocation.clearWatch(sample_location);
        var str = "Samples: "+track.length+"\n";
        for (var i = 0; i < track.length; i++) {
          let latlong = track[i];
          str = str+ latlong[0]+", "+latlong[1]+"\n";
        }
        // alert(str);
        if (track.length > 0) {
          if (confirm("View track?")) {
            // Using display to hide but apparently it means we can't use transitions, may want to revisit
            compass.style.display = "none";
            heading_container.style.display = "none";
            track_container.style.display= "block";
            startstop.innerHTML = "Done";
            // Clear any existing track
            if (confirm("Clear?")) {
              track_draw.clearRect(0,0,track_draw.width,track_draw.height);
            }
            //
            track_draw.imageSmoothingEnabled = false;
            // Draw track
            let maxLat  = track[0][0];
            let minLat  = track[0][0];
            let maxLong = track[0][1];
            let minLong = track[0][1];
            for (var i = 1; i < track.length; i++) {
              let latlong = track[i];
              if (latlong[0] > maxLat) {
                maxLat = latlong[0];
              }
              if (latlong[0] < minLat) {
                minLat = latlong[0];
              }
              if (latlong[1] > maxLong) {
                maxLong = latlong[1];
              }
              if (latlong[1] < minLong) {
                minLong = latlong[1];
              }
            }
            let latRange  = maxLat  - minLat;
            let longRange = maxLong - minLong;
            let scaleLat  = track_canvas.height / latRange;
            let scaleLong = track_canvas.width / longRange;
            let scale = 1;
            if (scaleLat < scaleLong) {
              scale = scaleLat;
            } else {
              scale = scaleLong;
            }
            // str = latRange + ", " + longRange + ", " + track_canvas.width + ", " + track_canvas.height + ", " + scale;
            // alert(str);
            for (var i = 0; i < track.length; i++) {
              let latlong = track[i];
              let x = (latlong[1]-minLong)*scale;
              let y = (latlong[0]-minLat)*scale;
              str = latlong[1] + ", " + minLong + ", " + latlong[0] + ", " + minLat + ": " + x + " - " + y;
              // alert(str);
              if (i==0) {
                track_draw.moveTo(x,y);
                track_draw.fillText(""+i,x,y);
              } else {
                track_draw.lineTo(x,y);
                track_draw.stroke();
              }
              if (i == track.length-1) {
                track_draw.fillText(""+i,x,y);
              }
            }
            // alert(str);
          }
        }
      }
    })

  </script>

</body>
